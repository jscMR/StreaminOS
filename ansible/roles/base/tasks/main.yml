---
- name: Update package database
  pacman:
    update_cache: yes
  tags: base

- name: Install base system packages
  pacman:
    name: "{{ base_packages }}"
    state: present
  tags: base

- name: Install Sway and related packages
  pacman:
    name: "{{ sway_packages }}"
    state: present
  tags:
    - base
    - sway

- name: Enable and start dhcpcd
  systemd:
    name: dhcpcd
    enabled: yes
    state: started
  when: enable_dhcpcd
  tags: base

- name: Create Sway configuration directory
  file:
    path: "{{ streamin_home }}/.config/sway"
    state: directory
    owner: "{{ streamin_user }}"
    mode: '0755'
  tags: sway

- name: Create Sway configuration from template
  template:
    src: sway-config.j2
    dest: "{{ streamin_home }}/.config/sway/config"
    owner: "{{ streamin_user }}"
    group: "{{ streamin_user }}"
    mode: '0644'
    force: yes
    backup: yes
  tags: sway
  
- name: Create StreaminOS scripts directory
  file:
    path: /opt/streamin-scripts
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags: base

- name: Install display management scripts
  copy:
    src: "{{ item }}"
    dest: /opt/streamin-scripts/{{ item }}
    owner: root
    group: root
    mode: '0755'
  loop:
    - list_displays.sh
    - set_resolution.sh
    - restart_sway.sh
  tags: base

- name: Verify Sway installation
  command: sway --version
  register: sway_version
  changed_when: false
  tags: sway

- name: Display installed Sway version
  debug:
    msg: "Sway installed: {{ sway_version.stdout }}"
  tags: sway
