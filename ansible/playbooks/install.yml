---
- name: Install and configure StreaminOS
  hosts: streamin_servers
  become: yes
  gather_facts: yes

  pre_tasks:
      - name: Display system information
        debug:
            msg: |
                ====================================
                StreaminOS Installation Starting
                ====================================
                Target Host: {{ ansible_hostname }}
                OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
                Kernel: {{ ansible_kernel }}

                User Configuration:
                - Admin User (SSH/Ansible): {{ ansible_user }}
                - Service User (Streaming): {{ streamin_user }}

                Installation will create dedicated 'streaminos' user
                for running all streaming services securely.
        tags: always

      - name: Verify we are on Arch Linux
        fail:
            msg: "This playbook only works on Arch Linux"
        when: ansible_distribution != "Archlinux"
        tags: always

  roles:
      # User setup must run first to create the streaminos user
      - role: user-setup
        tags:
            - user-setup
            - users
            - system

      # Base system with Sway compositor
      - role: base
        tags:
            - base
            - system

      # AUR helper (yay) - required for installing AUR packages
      - role: aur-helper
        tags:
            - aur-helper
            - packages
            - system

      # Sunshine game streaming server
      - role: sunshine
        tags:
            - sunshine
            - streaming

      # Steam game client
      - role: steam
        tags:
            - steam
            - games

      # Wake-on-LAN for remote power-on
      - role: wol
        tags:
            - wol
            - network
            - power

      # Steam Monitor - Auto-register games in Sunshine
      - role: steam-monitor
        tags:
            - steam-monitor
            - services
            - games

      # The following roles will be implemented progressively
      #
      # - role: amdgpu
      #   tags:
      #     - amdgpu
      #     - gpu
      #
      # - role: dashboard
      #   tags:
      #     - dashboard
      #     - ui

  post_tasks:
      - name: Display installation summary
        debug:
            msg: |
                ====================================
                StreaminOS - Installation Complete
                ====================================

                ✓ Users configured:
                  - Admin user '{{ ansible_user }}' for SSH/management
                  - Service user '{{ streamin_user }}' for streaming

                ✓ Base system installed:
                  - Sway (Wayland compositor with EVDI support)
                  - Auto-login configured on tty1
                  - System utilities and dependencies

                ✓ Streaming components:
                  - Sunshine (game streaming server)
                  - Avahi (mDNS autodiscovery)
                  - EVDI (virtual displays for headless streaming)

                ✓ Gaming components:
                  - Steam (game client and library)
                  - Sunshine apps configured (Desktop, Steam, Big Picture)

                ✓ Configuration locations:
                  - Sway: {{ streamin_home }}/.config/sway/config
                  - Sunshine: {{ streamin_home }}/.config/sunshine/
                  - Steam: {{ streamin_home }}/.local/share/Steam
                  - Services: {{ streamin_home }}/.config/systemd/user/
                  - EVDI scripts: /opt/evdi-scripts/
                  - Logs: journalctl -u <service> -f

                Next steps:
                1. Connect to StreaminOS using Moonlight client
                   - Auto-discover "streaminos" or connect to {{ ansible_host }}
                2. Launch "Desktop" or "Steam" app in Moonlight
                3. Login to Steam to access your game library
                4. Your games will appear in Sunshine for streaming
                5. Install additional components with tags:
                   - AMD GPU:   ansible-playbook install.yml --tags amdgpu
                   - Dashboard: ansible-playbook install.yml --tags dashboard

                5. Useful commands:
                   - List EVDI displays: /opt/evdi-scripts/list_virtual_displays.sh
                   - Check Sway outputs: swaymsg -t get_outputs
                   - Sunshine logs: journalctl --user -u sunshine.service -f

                For support: https://github.com/yourorg/StreaminOS
        tags: always
