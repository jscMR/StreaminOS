---
- name: Install and configure StreaminOS
  hosts: streamin_servers
  become: yes
  gather_facts: yes

  pre_tasks:
      - name: Display system information
        debug:
            msg: |
                ====================================
                StreaminOS Installation Starting
                ====================================
                Target Host: {{ ansible_hostname }}
                OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
                Kernel: {{ ansible_kernel }}

                User Configuration:
                - Admin User (SSH/Ansible): {{ ansible_user }}
                - Service User (Streaming): {{ streamin_user }}

                Installation will create dedicated 'streaminos' user
                for running all streaming services securely.
        tags: always

      - name: Verify we are on Arch Linux
        fail:
            msg: "This playbook only works on Arch Linux"
        when: ansible_distribution != "Archlinux"
        tags: always

  roles:
      # User setup must run first to create the streaminos user
      - role: user-setup
        tags:
            - user-setup
            - users
            - system

      # AUR helper (yay) - required for installing AUR packages
      - role: aur-helper
        tags:
            - aur-helper
            - packages
            - system

      # Gamescope micro-compositor for gaming
      - role: gamescope
        tags:
            - gamescope
            - compositor
            - system

      # Sunshine game streaming server
      - role: sunshine
        tags:
            - sunshine
            - streaming

      # Steam game client
      - role: steam
        tags:
            - steam
            - games

      # Wake-on-LAN for remote power-on
      - role: wol
        tags:
            - wol
            - network
            - power

      # The following roles will be implemented progressively
      #
      # - role: amdgpu
      #   tags:
      #     - amdgpu
      #     - gpu
      #
      # - role: dashboard
      #   tags:
      #     - dashboard
      #     - ui

  post_tasks:
      - name: Display installation summary
        debug:
            msg: |
                ====================================
                StreaminOS - Installation Complete
                ====================================

                ✓ Users configured:
                  - Admin user '{{ ansible_user }}' for SSH/management
                  - Service user '{{ streamin_user }}' for streaming

                ✓ Console OS Architecture:
                  - Gamescope (micro-compositor for gaming)
                  - On-demand launch (no persistent compositor)
                  - DRM backend for optimal performance
                  - Automatic window focus management

                ✓ Streaming components:
                  - Sunshine (game streaming server)
                  - KMS capture method (cap_sys_admin enabled)
                  - Avahi (mDNS autodiscovery)
                  - Software encoding (HEVC/H.265)

                ✓ Gaming components:
                  - Steam (game client and library)
                  - Gamescope integration enabled
                  - Sunshine app: Steam Big Picture only

                ✓ Configuration locations:
                  - Gamescope launcher: {{ streamin_home }}/.local/bin/launch-gamescope-steam.sh
                  - Sunshine: {{ streamin_home }}/.config/sunshine/
                  - Steam: {{ streamin_home }}/.local/share/Steam
                  - Services: {{ streamin_home }}/.config/systemd/user/

                Next steps:
                1. Connect to StreaminOS using Moonlight client
                   - Auto-discover "streaminos" or connect to {{ ansible_host }}
                2. Launch "Steam Big Picture" in Moonlight
                3. Login to Steam to access your game library
                4. Manage additional apps via Sunshine web UI if needed
                5. Install additional components with tags:
                   - AMD GPU:   ansible-playbook install.yml --tags amdgpu
                   - Dashboard: ansible-playbook install.yml --tags dashboard

                5. Useful commands:
                   - Check Sunshine: sudo -u streaminos systemctl --user status sunshine.service
                   - Sunshine logs: sudo -u streaminos journalctl --user -u sunshine.service -f
                   - Test gamescope: sudo -u streaminos gamescope -- glxgears
                   - Sunshine web UI: https://{{ ansible_host }}:47985

                For support: https://github.com/yourorg/StreaminOS
        tags: always
